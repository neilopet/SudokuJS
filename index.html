<html>
<head>
<title>SudokuJS</title>
<script>
/*
 * 1) Get empty cells
 * 2) Iterate each empty cell
 * 2a) Get cell buddies
 * 2b) Evaluate possibilities
 * 3) Solve single solution cells
 * 4) Iterate each bivalue cell (pivot: XY)
 * 4a) Identify pincers (cells XZ, YZ that share common X or common Y)
 * 4b) Eliminate all pincer intersect values from box containing XZ or YZ
 */

var validMoves = [1, 2, 3, 4, 5, 6, 7, 8, 9];

/*
// Solvable with Forced Entry alone
var matrix = [
	['', 1, 5, '', 6, 3, '', 4, ''],
	['', '', '', '', '', '' ,'', '', ''],
	[4, '', '', 1, '', 8, 5, '', ''],
	['', 6, '', 8, '', '', '', 2, 3],
	[2, '', '', 4, 3, 9, '', '', 8],
	[1, 3, '', '', '', 6, '', 5, ''],
	['', '', 9, 3, '', 1, '', '', 7],
	['', '', '', '', '', '', '', '', ''],
	['', 4, '', 7, 5, '', 1, 8, '']
];

// unsolvable - requires using techniques such as X Wing, XY Wing, etc.
var matrix = [
	['', 1, '', '', '', '', 9, '', 4],
	[2, '', '', 9, '', '', 7, 8, ''],
	[6, 7, 9, '', '', 3, '', '', ''],
	[4, '', '', '', 9, '', 5, '', ''],
	['', '', '', 2, '', 4, '', '', ''],
	['', '', 1, '', 7, '', '', '', 2],
	['', '', '', 8, '', '', 3, 4, 5],
	['', 2, 4, '', '', 6, '', '', 7],
	[1, '', 5, '', '', '', '', 2, '']
];

// Solvable with Forced Entry alone
var matrix = [
	['', '', 3, 5, '', 9, '', '', ''],
	['', 6, '', '', '', '', '', 2, 7],
	['', '', 8, '', '', 2, 4, 9, ''],
	[3, '', '', '', 2, '', 7, '', 5],
	['', '', 9, '', '', '', 8, '', ''],
	[5, '', 2, '', 8, '', '', '', 9],
	['', 9, 1, 4, '', '', 2, '', ''],
	[4, 3, '', '', '', '', '', 7, ''],
	['', '', '', 6, '', 5, 1, '', '']
];

// Solvable with Forced Entry alone
var matrix = [
	['', '', '', '', '', '', 7, '', ''],
	['', '', 7, 4, 9, 2, '', '', ''],
	[4, 3, 6, '', 8, '', '', '', ''],
	[7, '', '', 1, '', '', 2, '', 3],
	[1, 2, '', '', '', '', '', 8, 4],
	[6, '', 5, '', '', 8, '', '', 1],
	['', '', '', '', 2, '', 6, 1, 5],
	['', '', '', 7, 6, 5, 4, '', ''],
	['', '', 9, '', '', '', '', '', '']
];
*/

// unsolvable - requires using techniques such as X Wing, XY Wing, etc.
var matrix = [
	['', 1, '', '', '', '', 9, '', 4],
	[2, '', '', 9, '', '', 7, 8, ''],
	[6, 7, 9, '', '', 3, '', '', ''],
	[4, '', '', '', 9, '', 5, '', ''],
	['', '', '', 2, '', 4, '', '', ''],
	['', '', 1, '', 7, '', '', '', 2],
	['', '', '', 8, '', '', 3, 4, 5],
	['', 2, 4, '', '', 6, '', '', 7],
	[1, '', 5, '', '', '', '', 2, '']
];

function loadMatrix() {
	var sudoku = SudokuJS(matrix);

	console.table( sudoku );

	var solved = solveSingles( sudoku );

	trimmed = narrowPossibilities( solved );

	printMatrix(trimmed);

	var elements = document.getElementsByTagName('td');
	for(var i = 0, len = elements.length; i < len; i++) {
	    elements[i].onclick = function () {
	    	var coord = Point( this.cellIndex, this.parentNode.rowIndex );
	    	highlightMatrix( trimmed, coord );
	    }
	}
}

//////////////////////////////////////////
// helper methods
//

function highlightMatrix( matrix, point ) {
	//background: #77EC6F;
	var buddiesRef = getBuddiesRef( matrix, point );
	var cell = document.getElementsByClassName('cell_' + point.x + 'x' + point.y)[0];

	var elements = document.getElementsByTagName('td');
	for(var i = 0, len = elements.length; i < len; i++) {
		var name = elements[i].className.replace('/highlighted/', '');
		console.log(name);
	}

	cell.className = cell.className + ' highlighted';
}

function printMatrix( matrix ) {
	var outTable = document.getElementById('outTable');
	for (var i = 0; i < matrix[0].length; i++) {
		for (var j = 0; j < matrix[i].length; j++) {
			var row = outTable.getElementsByTagName('tr')[i];
			var cell = row.getElementsByTagName('td')[j];
			var val = matrix[i][j];
			if (val.length > 1) {
				val = '<span style="color:#f00;font-size:8px">' + val + '</span>';
			}
			cell.innerHTML = val;
			cell.className = "cell_" + j + 'x' + i;
		}
	}
}

Array.prototype.diff = function(a) {
    return this.filter(function(i) {return a.indexOf(i) < 0;});
};

function SudokuJS( matrix ) {
	var cellPossibleValues = [1, 2, 3, 4, 5, 6, 7, 8, 9];
	var result = [];

	for (var i = 0; i < matrix.length; i++) {
		result.push([]);
		for (var j = 0; j < matrix[i].length; j++) {
			result[i].push(
				(matrix[i][j] == 0) ? cellPossibleValues : [matrix[i][j]]
			);
		}
	}
	return result;
}

function solveSingles( inMatrix ) {
	var matrix = inMatrix.splice(0);
	var updated = false;
	for (var i = 0; i < matrix.length; i++) {
		for (var j = 0; j < matrix[i].length; j++) {
			var pivot = matrix[i][j];
			var buddiesObj = getBuddies(matrix, Point(j, i));

			var rowX = [], rowY = [], block = [];
			for(var c = 0; c < buddiesObj.x.length; c++) {
				if (buddiesObj.x[c].length == 1) {
					rowX.push(buddiesObj.x[c]);
				}
			}

			for(var c = 0; c < buddiesObj.y.length; c++) {
				if (buddiesObj.y[c].length == 1) {
					rowY.push(buddiesObj.y[c]);
				}
			}

			for(var c = 0; c < buddiesObj.block.length; c++) {
				if (buddiesObj.block[c].length == 1) {
					block.push(buddiesObj.block[c]);
				}
			}

			rowX = unique(quickSort(rowX));
			rowY = unique(quickSort(rowY));
			block = unique(quickSort(block));

			var combined = rowX.concat(rowY, block);
			var possibleValues = matrix[i][j].diff(unique(quickSort(combined)));

			if (possibleValues.length == 1 && matrix[i][j].length > 1) {
				matrix[i][j] = [possibleValues[0]];
				updated = true;
			}
		}
	}

	if (updated) {
		return solveSingles( matrix );
	}

	return matrix;
}

function narrowPossibilities( inMatrix ) {
	var matrix = inMatrix.splice(0);
	return matrix;
}

function getBuddies( matrix, point ) {
	var rowX = [], rowY = [], block = [];
	var y = point.y, x = point.x;
	for(var i = 0; i < matrix[y].length; i++) {
		rowX.push(matrix[y][i]);	
		rowY.push(matrix[i][x]);
	}
	block = getNBlock( matrix, getNBlockPoint( point ) );
	return {
		x: rowX,
		y: rowY,
		block: block
	}
}

function getBuddiesRef( matrix, point ) {
	var rowX = [], rowY = [], block = [];
	var y = point.y, x = point.x;
	for(var i = 0; i < matrix[y].length; i++) {
		rowX.push(Point(i, y));	
		rowY.push(Point(x, i));
	}
	block = getNBlockRef( matrix, getNBlockPoint( point ) );
	return {
		x: rowX,
		y: rowY,
		block: block
	}	
}

function getNBlock( matrix, point ) {
	var coord = getNBlockPoint( point );
	var ret = [];
	for (var i = coord.y, ilim = (coord.y + 3); i < ilim; i++) {
		for (var j = coord.x, jlim = (coord.x + 3); j < jlim; j++) {
			if (matrix[i][j] != '') {
				ret.push(matrix[i][j]);
			}
		}
	}
	return ret;
}

function getNBlockRef( matrix, point ) {
	var coord = getNBlockPoint( point );
	var ret = [];
	for (var i = coord.y, ilim = (coord.y + 3); i < ilim; i++) {
		for (var j = coord.x, jlim = (coord.x + 3); j < jlim; j++) {
			if (matrix[i][j] != '') {
				ret.push(Point(j, i));
			}
		}
	}
	return ret;
}

function getNBlockPoint( point ) {
	if (point.x < 3) {
		if (point.y < 3) {
			return Point(0, 0);
		}
		else if (point.y < 6) {
			return Point(0, 3);
		}
		else {
			return Point(0, 6);
		}
	}
	else if (point.x < 6) {
		if (point.y < 3) {
			return Point(3, 0);
		}
		else if (point.y < 6) {
			return Point(3, 3);
		}
		else {
			return Point(3, 6);
		}	
	}
	else {
		if (point.y < 3) {
			return Point(6, 0);
		}
		else if (point.y < 6) {
			return Point(6, 3);
		}
		else {
			return Point(6, 6);
		}
	}
}

function unique( array ) {
	var ret = [];
	for (var i = 0, j = -1; i < array.length; i++) {
		if (ret[j] != array[i]) {
			ret.push(array[i]);
			j++;
		}
	}
	return ret;	
}

function quickSort( array ) {
	if (array.length < 1) {
		return array;
	}
	var left = [], right = [], pivot = array[0];
	for (var i = 1; i < array.length; i++) {
		if (array[i] < pivot) {
			left.push(array[i]);
		}
		else {
			right.push(array[i]);
		}
	}
	return quickSort(left).concat(pivot, quickSort(right));
}

function Point( x, y ) {
	return {
		x: x, 
		y: y
	}
}

function transpose( array ) {
	return array[0].map(function(col, i) { 
		return array.map(function(row) { 
			return row[i];
		})
	});
}

</script>
<style>
table {
	border: 5px solid #000;
	border-collapse: collapse;
	table-layout: fixed;
}
table td {
	padding: 10px;
	border: 1px solid #333;
	width: 50px;
	height: 50px;
	max-width: 50px;
	text-align: center;
}
table td:nth-child(3),
table td:nth-child(6) {
	border-right: 5px solid #333;	
}
table tr:nth-child(3) td,
table tr:nth-child(6) td {
	border-bottom: 5px solid #333;		
}
td.highlighted {
	background: #77EC6F;
}
</style>
</head>
<body onload="loadMatrix();">

<table id="outTable">
	<tr>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
	</tr>
</table>

</body>
</html>
